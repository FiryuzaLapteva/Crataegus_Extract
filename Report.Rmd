---
title: '**Проспективное, многоцентровое, рандомизированное, двойное слепое, плацебо-контролируемое клиническое исследование эффективности и безопасности экстракта боярышника (Crataegus) у пациентов с хронической сердечной недостаточностью со сниженной фракцией выброса левого желудочка.**'
author: 'Выполнил(и): Бектур	Бердибеков, Анастасия	Генералова, Ирина	Михайлова, Фирюза Лаптева'
output:
  bookdown::word_document2:
    toc: true
    toc_depth: 4
  bookdown::html_document2:
    number_sections: true
    code_folding: hide
    toc: true
    toc_float: true
    toc_depth: 4
  bookdown::pdf_document2:
    toc: true
    toc_depth: 4
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(flextable)
library(tidyverse)
library(summarytools)
library(survminer)      # для выживаемости
library(survival) 
library(survRM2)        # для RMST
library(gt)             # форматирование таблиц
library(gtsummary)
library(kableExtra)
library(readxl)
```

```{r}
team1 <- read.csv("data/team1_ecrf_wide.csv", sep = ",")
dict <- read_excel("data/team1_ecrf_data_dictionary.xlsx")
data_surv <- team1 |> 
  select(
    id     = USUBJID,
    group  = ARM,
    Time   = V0_END_TTE_COMP_M,
    Event_OS = V0_END_COMP_EVENT,
    type   = V0_END_COMP_TYPE
  )
```

# Описательная характеристика показателей на первом визите.

В анализ включены 2200 пациентов. Средний возраст составил 66.1 ± 9.9 года, медиана 66 лет, диапазон от 40 до 90 лет. Средний рост пациентов составил 169.7 ± 8.9 см, масса тела - 81.4 ± 15.6 кг. Средний индекс массы тела был 28.5 ± 6.3 кг/м², медиана 28.1 кг/м², при диапазоне значений от 13.0 до 65.6 кг/м², что соответствует преимущественно избыточной массе тела.

Исходный уровень NT-proBNP характеризовался выраженной вариабельностью и асимметрией распределения: среднее значение составило 1722.4 ± 1582.1 пг/мл, медиана - 1251.0 пг/мл. Показатели функции почек были умеренно снижены: средняя СКФ 68.1 ± 17.4 мл/мин, медиана 68 мл/мин. Средний уровень креатинина составил 1.0 ± 0.3 мг/дл, калия - 4.2 ± 0.4 ммоль/л.

Качество жизни по шкале KCCQ характеризовалось умеренным снижением: среднее значение общего балла составило 54.7 ± 17.9, медиана - 55 баллов при полном диапазоне значений от 0 до 100.

В каждую группу лечения было включено по 1100 пациентов. Исходные демографические и клинические характеристики в группах Crataegus и Placebo были сопоставимы.

Средний возраст в группе Crataegus составил 65.9 ± 10.1 года, в группе Placebo 66.4 ± 9.7 года. Антропометрические показатели практически не различались между группами: средний BMI составил 28.5 ± 6.2 кг/м² в группе Crataegus и 28.6 ± 6.4 кг/м² в группе Placebo.

Показатели функции почек были сходными: средняя СКФ 68.3 ± 17.3 мл/мин в группе Crataegus и 67.9 ± 17.5 мл/мин в группе Placebo, уровни креатинина и калия также не демонстрировали клинически значимых различий.

Исходные уровни NT-proBNP были высокими и сопоставимыми между группами: среднее значение 1740.4 ± 1629.3 пг/мл в группе Crataegus и 1704.3 ± 1534.1 пг/мл в группе Placebo, медианные значения также близки. Показатели качества жизни по KCCQ были практически идентичны в обеих группах, со средними значениями около 55 баллов.

Исходные демографические и клинические характеристики пациентов в группах Crataegus и Placebo хорошо сбалансированы, клинически значимых различий между группами на исходном уровне не выявлено.


```{r tbl-demographics, echo=TRUE, tab.cap="Клинико-демографические характеристики групп"}
df <- team1

labels_list <- dict %>%
  filter(Column %in% names(df)) %>%    # берем только те, что есть в данных
  select(Column, Label) %>% 
  tibble::deframe() %>%                # превращает в именованный вектор
  as.list() 

tbl_by_arm <- df %>%
  mutate(
    ARM = factor(ARM, levels = c("Placebo", "Crataegus"))
  ) %>%
  select(
    ARM,
    starts_with("V1")
  ) %>%
  tbl_summary(
    by = ARM,
    type = list(all_continuous() ~ "continuous2"),
    statistic = list(
      all_continuous2() ~ c("{mean} ({sd})", "{min} – {max}"),
      all_categorical() ~ "{n} ({p}%)",
      c(`V1_KCCQ_OS`, `V1_BIO_NTPROBNP`) ~ c("{median} ({p25}; {p75})", "{min} – {max}")),
    digits = all_continuous() ~ 1,
    missing = "no",
    label = labels_list,
    value = list(V1_DEM_SEX ~ "M") )%>%
  add_n() %>%
  add_overall(last = TRUE) %>%
  bold_labels()

tbl_by_arm
```



# ПКТ

Для оценка первичной конечной точки  будет проведен анализ с использованием модели пропорциональных рисков Кокса (Cox Proportional Hazards Model).

Для подтверждения корректности использования модели Кокса была проведена проверка допущения о пропорциональности рисков (тест на основе остатков Шонфилда). Результаты теста (p=0.28 для группы терапии и p=0.28 для модели в целом) подтверждают соблюдение допущения о пропорциональности рисков. Это позволяет считать полученную оценку Hazard Ratio (HR) корректной и стабильной на всем интервале наблюдения (24 месяца).

Данное конфирматорное исследование было спланировано с мощностью 80% для обнаружения HR=0.78. Полученный результат HR=1.01 при p=0.87 свидетельствует о том, что в данной популяции пациентов, получающих оптимальную современную терапию ХСН, добавление экстракта боярышника не приносит дополнительного статистически значимого снижения риска по жестким конечным точкам.

```{r}
cox_fit <- coxph(Surv(Time, Event_OS) ~ group, data = data_surv)

pretty_table <- cox_fit |>
  broom::tidy(exponentiate = TRUE, conf.int = TRUE) |>
  mutate(
    HR = sprintf("%.2f", estimate),
    `95% CI` = sprintf("%.2f-%.2f", conf.low, conf.high),
    p_value = case_when(
      p.value < 0.001 ~ "<0.001",
      p.value < 0.01 ~ sprintf("%.3f", p.value),
      TRUE ~ sprintf("%.3f", p.value)
    ),
    Significance = case_when(
      p.value < 0.001 ~ "***",
      p.value < 0.01 ~ "**",
      p.value < 0.05 ~ "*",
      TRUE ~ ""
    )
  ) |>
  select(
    Переменная = term,
    HR,
    `95% CI`,
    `p-value` = p_value,
    Significance
  ) |>
  kable()
# summary(cox_fit)
pretty_table
```

```{r fig.width=8, fig.height=6}
# Запускаем тест на пропорциональность
test_ph <- cox.zph(cox_fit)

print(test_ph)

# Рисуем графики для визуальной оценки

ggcoxzph(test_ph)
```
# ВКТ

Кривые выживаемости групп боярышника и плацебо практически полностью накладываются друг на друга на протяжении всех 24 месяцев. Наличие широких и пересекающихся доверительных интервалов (shaded areas) подтверждает отсутствие статистически значимого расхождения. Терапия не продемонстрировала превосходства над плацебо.

```{r fig.height=8, fig.width=10}
surv_object <- Surv(time = data_surv$Time, event = data_surv$Event_OS)

fit_2 <- survfit(surv_object ~ group, data = data_surv)

p2 <- ggsurvplot(fit_2, 
                 data = data_surv,
                 conf.int = TRUE,
                 surv.median.line = "hv",
                 xlab="Month",
                 risk.table = TRUE,
                 tables.height = 0.25,
                 pval = TRUE,
                 pval.coord = c(22, 0.7),
                 break.time.by = 6,
                 xlim = c(0, 24))
p2
```
Значение p=1(крайне редкое для реальных данных) указывает на абсолютную идентичность кривых накопления событий госпитализации в обеих группах. Это означает, что вероятность попасть в больницу с декомпенсацией СН была абсолютно одинаковой как для пациентов, принимавших Crataegus, так и для группы контроля. 

В отношении наиболее «жесткой» точки — смертности — наблюдается минимальное, статистически незначимое расхождение кривых. 
```{r  fig.height=8, fig.width=10}
event_types <- c("HF_HOSP", "CV_DEATH")

# Мапим по списку событий
plots_list <- map(event_types, function(current_event) {
  
  # Мы создаем колонку 'is_event', которая будет TRUE (1) для текущего типа события.
  temp_data <- data_surv %>%
    mutate(is_event = (type == current_event))
  fit <- survfit(Surv(Time, is_event) ~ group, data = temp_data)
  
  ggsurvplot(fit, 
             data = temp_data,
             conf.int = TRUE,
             risk.table = TRUE,
             pval = TRUE,
             legend.labs = c("Crataegus", "Placebo"), 
             legend.title = "Group",
             title = paste("Outcome:", current_event), # Используем current_event
             xlab = "Months",
             xlim = c(0, 24),
             break.time.by = 6,
             palette = "Dark2")
})

plots_list[[1]] # График для HF_HOSP
plots_list[[2]] # График для CV_DEATH
```






















