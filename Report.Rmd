---
title: 'Проспективное, многоцентровое, рандомизированное, двойное слепое, плацебо-контролируемое клиническое исследование эффективности и безопасности экстракта боярышника (Crataegus) у пациентов с хронической сердечной недостаточностью со сниженной фракцией выброса левого желудочка.'
author: 'Выполнил(и): Бектур	Бердибеков, Анастасия	Генералова, Ирина	Михайлова, Фирюза Лаптева'
toc-title: "Оглавление"
output:
  bookdown::word_document2:
    toc: true
    toc_depth: 4
  bookdown::html_document2:
    number_sections: true
    code_folding: hide
    toc: true
    toc_float: true
    toc_depth: 4
  bookdown::pdf_document2:
    toc: true
    toc_depth: 4
---

```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = FALSE, warning = FALSE)

library(flextable)
library(readr)
library(gtsummary)
library(dplyr)
library(ggplot2)
library(epitools)
library(tidyverse)
library(survminer)      # для выживаемости
library(survival) 
library(survRM2)        # для RMST
library(gt)             # форматирование таблиц
library(gtsummary)
library(kableExtra)
library(readxl)
library(broom)
```

```{r}
team1 <- read.csv("data/team1_ecrf_wide.csv", sep = ",")
dict <- read_excel("data/team1_ecrf_data_dictionary.xlsx")
data_surv <- team1 |> 
  select(
    id     = USUBJID,
    group  = ARM,
    Time   = V0_END_TTE_COMP_M,
    Event_OS = V0_END_COMP_EVENT,
    type   = V0_END_COMP_TYPE
  )
```

# Проверка данных

По доступным данным визита V1 формальные отклонения от критериев включения/невключения были выявлены у 417 пациентов (19.0%). Основной вклад (398 пациентов, 94.5%) был обусловлен значениями NT-proBNP ниже условно принятого порога ≥600 пг/мл. Следует отметить, что в базе отсутствовали данные о наличии фибрилляции предсердий и недавних госпитализаций по поводу ХСН, что не позволило применить дифференцированные пороги NT-proBNP, предусмотренные протоколом. Кроме того, у 23 пациентов (1.0%) отмечалось снижение eGFR <30 мл/мин/1,73 м². Несмотря на то что снижение eGFR <30 мл/мин/1,73 м² являлось формальным критерием невключения, данные пациенты не были исключены из основного анализа, который выполнялся по принципу intention-to-treat. Выявленные несоответствия по NT-proBNP следует рассматривать как потенциальные и обусловленные ограничениями доступных данных.

```{r}

screening <- team1 %>%
  mutate(
    fail_age  = V1_DEM_AGE < 18,
    fail_sex  = is.na(V1_DEM_SEX),
    fail_ntp  = V1_BIO_NTPROBNP < 600,   # условно, по протоколу
    fail_egfr = V1_BIO_EGFR < 30,
    any_fail  = fail_age | fail_sex | fail_ntp | fail_egfr
  )

```

```{r}
screening %>%
  summarise(
    "Возраст" = sum(fail_age,  na.rm = TRUE),
    "Пол" = sum(fail_sex,  na.rm = TRUE),
    "NT-proBNP" = sum(fail_ntp,  na.rm = TRUE),
    "СКФ (eGFR)" = sum(fail_egfr, na.rm = TRUE),
    "Всего не подошло" = sum(any_fail,  na.rm = TRUE)
  ) %>%
  flextable() %>%
  autofit() %>% # Подогнать ширину под содержимое
  theme_booktabs() %>% 
  set_caption("Количество пациентов с отклонениями на этапах вкл/искл.") %>%
  bold(j = "Всего не подошло") 

```

# Описательная характеристика показателей на первом визите.

В анализ включены 2200 пациентов. Средний возраст составил 66.1 ± 9.9 года, медиана 66 лет, диапазон от 40 до 90 лет. Средний рост пациентов составил 169.7 ± 8.9 см, масса тела - 81.4 ± 15.6 кг. Средний индекс массы тела был 28.5 ± 6.3 кг/м², медиана 28.1 кг/м², при диапазоне значений от 13.0 до 65.6 кг/м², что соответствует преимущественно избыточной массе тела.

Исходный уровень NT-proBNP характеризовался выраженной вариабельностью и асимметрией распределения: среднее значение составило 1722.4 ± 1582.1 пг/мл, медиана - 1251.0 пг/мл. Показатели функции почек были умеренно снижены: средняя СКФ 68.1 ± 17.4 мл/мин, медиана 68 мл/мин. Средний уровень креатинина составил 1.0 ± 0.3 мг/дл, калия - 4.2 ± 0.4 ммоль/л.

Качество жизни по шкале KCCQ характеризовалось умеренным снижением: среднее значение общего балла составило 54.7 ± 17.9, медиана - 55 баллов при полном диапазоне значений от 0 до 100.

В каждую группу лечения было включено по 1100 пациентов. Исходные демографические и клинические характеристики в группах Crataegus и Placebo были сопоставимы.

Средний возраст в группе Crataegus составил 65.9 ± 10.1 года, в группе Placebo 66.4 ± 9.7 года. Антропометрические показатели практически не различались между группами: средний BMI составил 28.5 ± 6.2 кг/м² в группе Crataegus и 28.6 ± 6.4 кг/м² в группе Placebo.

Показатели функции почек были сходными: средняя СКФ 68.3 ± 17.3 мл/мин в группе Crataegus и 67.9 ± 17.5 мл/мин в группе Placebo, уровни креатинина и калия также не демонстрировали клинически значимых различий.

Исходные уровни NT-proBNP были высокими и сопоставимыми между группами: среднее значение 1740.4 ± 1629.3 пг/мл в группе Crataegus и 1704.3 ± 1534.1 пг/мл в группе Placebo, медианные значения также близки. Показатели качества жизни по KCCQ были практически идентичны в обеих группах, со средними значениями около 55 баллов.

Исходные демографические и клинические характеристики пациентов в группах Crataegus и Placebo хорошо сбалансированы, клинически значимых различий между группами на исходном уровне не выявлено.


```{r tbl-demographics, echo=FALSE, tab.cap="Клинико-демографические характеристики групп"}
df <- team1

labels_list <- dict %>%
  filter(Column %in% names(df)) %>%    # берем только те, что есть в данных
  select(Column, Label) %>% 
  tibble::deframe() %>%                # превращает в именованный вектор
  as.list() 

tbl_by_arm <- df %>%
  mutate(
    ARM = factor(ARM, levels = c("Placebo", "Crataegus"))
  ) %>%
  select(
    ARM,
    starts_with("V1")
  ) %>%
  tbl_summary(
    by = ARM,
    type = list(all_continuous() ~ "continuous2"),
    statistic = list(
      all_continuous2() ~ c("{mean} ({sd})", "{min} – {max}"),
      all_categorical() ~ "{n} ({p}%)",
      c(`V1_KCCQ_OS`, `V1_BIO_NTPROBNP`) ~ c("{median} ({p25}; {p75})", "{min} – {max}")),
    digits = all_continuous() ~ 1,
    missing = "no",
    label = labels_list,
    value = list(V1_DEM_SEX ~ "M") )%>%
  add_n() %>%
  add_overall(last = TRUE) %>%
  bold_labels() %>%
  as_flex_table() %>% 
  theme_booktabs() %>% 
  autofit() %>% 
  set_table_properties(layout = "autofit", width = 1) %>% 
  # Задаем заголовок здесь (внутри скобок):
  set_caption("Клинико-демографические характеристики групп")

tbl_by_arm
```


# Анализ ПКТ

Для оценка первичной конечной точки  будет проведен анализ с использованием модели пропорциональных рисков Кокса (Cox Proportional Hazards Model).

Для подтверждения корректности использования модели Кокса была проведена проверка допущения о пропорциональности рисков (тест на основе остатков Шонфилда). Результаты теста (p=0.28 для группы терапии и p=0.28 для модели в целом) подтверждают соблюдение допущения о пропорциональности рисков. Это позволяет считать полученную оценку Hazard Ratio (HR) корректной и стабильной на всем интервале наблюдения (24 месяца).

Данное конфирматорное исследование было спланировано с мощностью 80% для обнаружения HR=0.78. Полученный результат HR=1.01 при p=0.87 свидетельствует о том, что в данной популяции пациентов, получающих оптимальную современную терапию ХСН, добавление экстракта боярышника не приносит дополнительного статистически значимого снижения риска по жестким конечным точкам.

```{r}
cox_fit <- coxph(Surv(Time, Event_OS) ~ group, data = data_surv)

pretty_table <- cox_fit |>
  broom::tidy(exponentiate = TRUE, conf.int = TRUE) |>
  mutate(
    HR = sprintf("%.2f", estimate),
    `95% CI` = sprintf("%.2f-%.2f", conf.low, conf.high),
    p_value = case_when(
      p.value < 0.001 ~ "<0.001",
      p.value < 0.01 ~ sprintf("%.3f", p.value),
      TRUE ~ sprintf("%.3f", p.value)
    ),
    Significance = case_when(
      p.value < 0.001 ~ "***",
      p.value < 0.01 ~ "**",
      p.value < 0.05 ~ "*",
      TRUE ~ ""
    )
  ) |>
  select(
    Переменная = term,
    HR,
    `95% CI`,
    `p-value` = p_value
  ) |>
  flextable() |>
  theme_booktabs() |>          # Научный стиль
  autofit() |>                 # Автоширина колонок
  align(j = 2:4, align = "center", part = "all") |> 
  set_table_properties(layout = "autofit", width = 1) |> 
  set_caption("Результаты анализа пропорциональных рисков Кокса") |>
  bold(part = "header")

pretty_table
```

```{r fig.width=8, fig.height=6}
# Запускаем тест на пропорциональность
test_ph <- cox.zph(cox_fit)


# Рисуем графики для визуальной оценки

ggcoxzph(test_ph)
```

# Анализ ВКТ

При оценке вторичной конечной точки анализ выживаемости не выявил статистически значимых различий между группой экстракта боярышника и группой плацебо. Кривые выживаемости (Каплана-Мейера) демонстрируют высокую степень конгруэнтности на протяжении всего 24-месячного периода наблюдения. Выраженная суперпозиция доверительных интервалов подтверждает отсутствие превосходства исследуемой терапии над контрольной группой.

```{r fig.height=8, fig.width=10}
surv_object <- Surv(time = data_surv$Time, event = data_surv$Event_OS)

fit_2 <- survfit(surv_object ~ group, data = data_surv)

p2 <- ggsurvplot(fit_2, 
                 data = data_surv,
                 conf.int = TRUE,
                 surv.median.line = "hv",
                 xlab="Month",
                 risk.table = TRUE,
                 tables.height = 0.25,
                 pval = TRUE,
                 pval.coord = c(22, 0.7),
                 break.time.by = 6,
                 xlim = c(0, 24))
p2
```
Значение p=1(крайне редкое для реальных данных) указывает на абсолютную идентичность кривых накопления событий госпитализации в обеих группах. Это означает, что вероятность попасть в больницу с декомпенсацией СН была абсолютно одинаковой как для пациентов, принимавших Crataegus, так и для группы контроля. 

В отношении наиболее «жесткой» точки — смертности — наблюдается минимальное, статистически незначимое расхождение кривых. 
```{r  fig.height=8, fig.width=10}
event_types <- c("HF_HOSP", "CV_DEATH")

# Мапим по списку событий
plots_list <- map(event_types, function(current_event) {
  
  # Мы создаем колонку 'is_event', которая будет TRUE (1) для текущего типа события.
  temp_data <- data_surv %>%
    mutate(is_event = (type == current_event))
  fit <- survfit(Surv(Time, is_event) ~ group, data = temp_data)
  
  ggsurvplot(fit, 
             data = temp_data,
             conf.int = TRUE,
             risk.table = TRUE,
             pval = TRUE,
             legend.labs = c("Crataegus", "Placebo"), 
             legend.title = "Group",
             title = paste("Outcome:", current_event), # Используем current_event
             xlab = "Months",
             xlim = c(0, 24),
             break.time.by = 6,
             palette = "Dark2")
})

plots_list[[1]] # График для HF_HOSP
plots_list[[2]] # График для CV_DEATH
```

Анализ динамики качества жизни по шкале KCCQ 

Исходные значения суммарного балла Kansas City Cardiomyopathy Questionnaire (KCCQ) были сопоставимы между группами лечения. Для анализов через 12 и 24 месяца использовались данные пациентов с доступной оценкой KCCQ на соответствующем визите. Статистически значимых различий между группами лечения выявлено не было. Через 12 месяцев наблюдения скорректированная межгрупповая разница суммарного балла KCCQ (боярышник минус плацебо) составила 0,3 балла (95% ДИ от −1,0 до 1,5; p = 0,678). Через 24 месяца наблюдения соответствующая скорректированная межгрупповая разница составила 0,9 балла (95% ДИ от −0,6 до 2,4; p = 0,234). 

```{r}
team1 <- team1 %>%
  mutate(
    death_event = (V0_END_COMP_TYPE == "CV_DEATH") & (V0_END_COMP_EVENT == 1),
    death_before_12m = death_event & V0_END_TTE_COMP_M < 12,
    death_before_24m = death_event & V0_END_TTE_COMP_M < 24
  )

tbl_events <- team1 %>%
  select(V0_END_COMP_TYPE, death_before_12m, death_before_24m) %>%
  mutate(
    # Сделаем более красивые названия для категорий внутри типа события, если нужно
    V0_END_COMP_TYPE = as.character(V0_END_COMP_TYPE)
  )

# 2. Создаем таблицу
outcomes_table <- tbl_events %>%
  tbl_summary(
    missing = "ifany", # покажет NA, если они есть (как в вашем useNA = "ifany")
    label = list(
      V0_END_COMP_TYPE ~ "Тип зарегистрированного осложнения",
      death_before_12m ~ "Смерть от ССЗ в течение 12 мес.",
      death_before_24m ~ "Смерть от ССЗ в течение 24 мес."
    ),
    # Для логических переменных (смерть) покажем только количество "TRUE"
    value = list(
      death_before_12m ~ TRUE, 
      death_before_24m ~ TRUE
    )
  ) %>%
  bold_labels() %>%
  # Конвертируем для Word
  as_flex_table() %>%
  theme_booktabs() %>%
  autofit() %>%
  set_table_properties(layout = "autofit", width = 1) %>%
  set_caption("Частота регистрации сердечно-сосудистых осложнений и летальных исходов")

# Вывод
outcomes_table
```




```{r}
# 1) Подготовка данных KCCQ для ANCOVA
dat_kccq <- team1 %>%
  transmute(
    USUBJID,
    ARM = factor(ARM, levels = c("Placebo", "Crataegus")),
    KCCQ_BL = V1_KCCQ_OS,
    KCCQ_12 = ifelse(death_before_12m, NA, V6_KCCQ_OS),
    KCCQ_24 = ifelse(death_before_24m, NA, V8_KCCQ_OS)
  )
```


```{r ancova}
fit12 <- lm(KCCQ_12 ~ ARM + KCCQ_BL, data = dat_kccq)

res12 <- broom::tidy(fit12, conf.int = TRUE) %>%
  filter(term == "ARMCrataegus") %>%
  transmute(
    VISIT = "12 мес",
    diff = estimate,
    lcl = conf.low,
    ucl = conf.high,
    pval = p.value
  )

fit24 <- lm(KCCQ_24 ~ ARM + KCCQ_BL, data = dat_kccq)

res24 <- broom::tidy(fit24, conf.int = TRUE) %>%
  filter(term == "ARMCrataegus") %>%
  transmute(
    VISIT = "24 мес",
    diff = estimate,
    lcl = conf.low,
    ucl = conf.high,
    pval = p.value
  )
kccq_results <- bind_rows(res12, res24) %>%
  mutate(
    # Форматируем среднюю разницу и доверительный интервал
    diff_ci = sprintf("%.2f (%.2f; %.2f)", diff, lcl, ucl),
    
    # Форматируем p-value
    pval_fmt = case_when(
      pval < 0.001 ~ "<0.001",
      pval < 0.05  ~ sprintf("%.3f", pval),
      TRUE         ~ sprintf("%.3f", pval)
    )
  ) %>%
  select(
    "Визит" = VISIT,
    "Межгрупповая разница (95% ДИ)" = diff_ci,
    "p-значение" = pval_fmt
  )

# 2. Выводим через flextable
kccq_results_table <- kccq_results %>%
  flextable() %>%
  theme_booktabs() %>%
  autofit() %>%
  # Центрируем данные в колонках с цифрами
  align(j = 2:3, align = "center", part = "all") %>%
  # Растягиваем таблицу по ширине страницы Word
  set_table_properties(layout = "autofit", width = 1) %>%
  # Добавляем заголовок (автоматическая нумерация)
  set_caption("Оценка межгрупповых различий качества жизни (KCCQ) с поправкой на исходный уровень (ANCOVA)") %>%
  # Добавляем примечание под таблицей
  add_footer_lines("Разница рассчитана для группы Боярышник относительно группы Плацебо.")

kccq_results_table
```


```{r}
# helpers 
msd <- function(m, s, d = 1) sprintf(paste0("%.", d, "f±%.", d, "f"), m, s)
ci95 <- function(est, lcl, ucl, d = 1) sprintf(paste0("%.", d, "f (%.", d, "f до %.", d, "f)"), est, lcl, ucl)
fmt_p <- function(p) ifelse(is.na(p), "", ifelse(p < 0.001, "<0.001", sprintf("%.3f", p)))

#  data 
dat <- team1 %>%
  transmute(
    USUBJID,
    arm = factor(ARM, levels = c("Placebo", "Crataegus")),
    KCCQ0  = V1_KCCQ_OS,
    KCCQ12 = ifelse(death_before_12m, NA, V6_KCCQ_OS),
    KCCQ24 = ifelse(death_before_24m, NA, V8_KCCQ_OS)
  )

# ANCOVA effects (12 and 24 отдельно) 
eff_ancova <- function(y, section_label) {
  fit <- lm(reformulate(c("arm", "KCCQ0"), response = y), data = dat)
  broom::tidy(fit, conf.int = TRUE) %>%
    filter(term == "armCrataegus") %>%
    transmute(
      section = section_label,
      diff_ci = ci95(estimate, conf.low, conf.high, 1),
      p = p.value
    )
}

e12 <- eff_ancova("KCCQ12", "Через 12 месяцев")
e24 <- eff_ancova("KCCQ24", "Через 24 месяца")

#  section rows builder (baseline within same visit N) 
make_section_rows <- function(section_label, yvar, eff_row) {

  pdat <- dat %>% filter(arm == "Placebo")
  cdat <- dat %>% filter(arm == "Crataegus")

  yp <- pdat[[yvar]]
  yc <- cdat[[yvar]]

  ip <- !is.na(yp)   # есть оценка на визите
  ic <- !is.na(yc)

  # baseline и delta считаем в той же выборке
  blp <- pdat$KCCQ0[ip]
  blc <- cdat$KCCQ0[ic]

  dp <- yp[ip] - blp
  dc <- yc[ic] - blc

  tibble(
    Секция = section_label,
    `Конечная точка` = c(
      "Число пациентов с оценкой KCCQ",
      "Исходное значение — баллы",
      "Значение на визите — баллы",
      "Улучшение — баллы"
    ),
    `Плацебо` = c(
      sum(ip),
      msd(mean(blp, na.rm = TRUE), sd(blp, na.rm = TRUE), 1),
      msd(mean(yp[ip], na.rm = TRUE), sd(yp[ip], na.rm = TRUE), 1),
      msd(mean(dp, na.rm = TRUE), sd(dp, na.rm = TRUE), 1)
    ),
    `Боярышник` = c(
      sum(ic),
      msd(mean(blc, na.rm = TRUE), sd(blc, na.rm = TRUE), 1),
      msd(mean(yc[ic], na.rm = TRUE), sd(yc[ic], na.rm = TRUE), 1),
      msd(mean(dc, na.rm = TRUE), sd(dc, na.rm = TRUE), 1)
    ),
    `Средняя межгрупповая разница (95% ДИ)` = c("", "", "", eff_row$diff_ci),
    `p-значение` = c("", "", "", fmt_p(eff_row$p))
  )
}

#  baseline block (all with baseline) 
base_p <- dat$KCCQ0[dat$arm == "Placebo"]
base_c <- dat$KCCQ0[dat$arm == "Crataegus"]

base_rows <- tibble(
  Секция = "Исходно",
  `Конечная точка` = c("Число пациентов с оценкой KCCQ", "Значение — баллы"),
  `Плацебо` = c(
    sum(!is.na(base_p)),
    msd(mean(base_p, na.rm = TRUE), sd(base_p, na.rm = TRUE), 1)
  ),
  `Боярышник` = c(
    sum(!is.na(base_c)),
    msd(mean(base_c, na.rm = TRUE), sd(base_c, na.rm = TRUE), 1)
  ),
  `Средняя межгрупповая разница (95% ДИ)` = c("", ""),
  `p-значение` = c("", "")
)

# combine all 
tbl_df <- bind_rows(
  base_rows,
  make_section_rows("Через 12 месяцев", "KCCQ12", e12),
  make_section_rows("Через 24 месяца", "KCCQ24", e24)
)

#  render 
tbl_kccq <- tbl_df %>%
  gt(groupname_col = "Секция") %>%
  tab_header(
    title = "",
    subtitle = "Данные представлены как среднее±СО. Межгрупповая разница на 12 и 24 мес оценена ANCOVA с поправкой на исходный KCCQ."
  ) %>%
  cols_label(
    `Конечная точка` = "Конечная точка",
    `Плацебо` = "Плацебо",
    `Боярышник` = "Боярышник",
    `Средняя межгрупповая разница (95% ДИ)` = "Средняя межгрупповая разница (95% ДИ)",
    `p-значение` = "p-значение"
  ) %>%
  cols_align("left", columns = c(`Конечная точка`)) %>%
  cols_align("center", columns = c(`Плацебо`, `Боярышник`, `Средняя межгрупповая разница (95% ДИ)`, `p-значение`)) %>%
 sub_missing(everything(), missing_text = "") %>%
  tab_options(
    table.font.size = px(12),
    row_group.font.weight = "bold",
    data_row.padding = px(4)
  )

tbl_kccq
```
Таблица Х. Динамика качества жизни по шкале KCCQ


Дополнительно динамика качества жизни по KCCQ в зависимости от группы лечения в различных сроках наблюдения отражены на рисунке Х.

```{r}
kccq_sum <- team1 %>%
  transmute(
    arm = factor(ARM, levels = c("Placebo", "Crataegus")),
    BL  = V1_KCCQ_OS,
    M12 = ifelse(death_before_12m, NA, V6_KCCQ_OS),
    M24 = ifelse(death_before_24m, NA, V8_KCCQ_OS)
  ) %>%
  pivot_longer(cols = c(BL, M12, M24), names_to = "VISIT", values_to = "KCCQ") %>%
  mutate(
    VISIT = factor(VISIT, levels = c("BL", "M12", "M24"),
                   labels = c("Исходно", "12 месяцев", "24 месяца"))
  ) %>%
  group_by(arm, VISIT) %>%
  summarise(
    n = sum(!is.na(KCCQ)),
    mean = mean(KCCQ, na.rm = TRUE),
    se = sd(KCCQ, na.rm = TRUE) / sqrt(n),
    lcl = mean - qt(0.975, df = n - 1) * se,
    ucl = mean + qt(0.975, df = n - 1) * se,
    .groups = "drop"
  )
```


```{r}

pd <- position_dodge(width = 0.25)

ggplot(kccq_sum,
       aes(x = VISIT, y = mean,
           group = arm, colour = arm)) +
  geom_line(position = pd, linewidth = 0.9) +
  geom_point(position = pd, size = 2.2) +
  geom_errorbar(
    aes(ymin = lcl, ymax = ucl),
    position = pd,
    width = 0.12,
    linewidth = 0.7
  ) +
  scale_y_continuous(
    limits = c(40, 80),
    breaks = seq(40, 80, 5)
  ) +
  labs(
    y = "KCCQ, среднее значение (95% ДИ), баллы",
    x = NULL,
    colour = "Группа лечения"
  ) +
  theme_minimal(base_size = 12)
```
Рисунок X. Динамика качества жизни по шкале KCCQ в группах лечения


Как уже отмечалось, клинически значимое улучшение определено как увеличение суммарного балла KCCQ ≥ 5 пунктов по сравнению с исходным уровнем. В анализ включены пациенты с доступной оценкой KCCQ на соответствующем визите. Через 12 месяцев клинически значимое улучшение качества жизни (ΔKCCQ ≥ 5 баллов) было отмечено у 431 пациента (46,3%) в группе плацебо и у 448 пациентов (48,2%) в группе боярышника; статистически значимых различий между группами не выявлено (χ² с поправкой Йейтса, p = 0,431).
Через 24 месяца клинически значимое улучшение наблюдалось у 352 пациентов (41,7%) в группе плацебо и у 383 пациентов (45,2%) в группе боярышника; межгрупповые различия также не достигли статистической значимости (χ² с поправкой Йейтса, p = 0,159) (Таблица Х). 

```{r}
library(gt)

# dat_kccq: USUBJID, ARM, KCCQ_BL, KCCQ_12, KCCQ_24

# 1) long с респондерами и фактом наличия оценки на визите
resp_long <- dat_kccq %>%
  mutate(
    resp12 = !is.na(KCCQ_12) & (KCCQ_12 - KCCQ_BL >= 5),
    resp24 = !is.na(KCCQ_24) & (KCCQ_24 - KCCQ_BL >= 5),
    has12  = !is.na(KCCQ_12),
    has24  = !is.na(KCCQ_24)
  ) %>%
  select(USUBJID, ARM, resp12, resp24, has12, has24) %>%
  pivot_longer(
    cols = c(resp12, resp24, has12, has24),
    names_to = c(".value", "tp"),
    names_pattern = "(resp|has)(12|24)"
  ) %>%
  mutate(
    VISIT = ifelse(tp == "12", "12 месяцев", "24 месяца"),
    ARM = factor(ARM, levels = c("Placebo", "Crataegus")),
    Группа = recode(as.character(ARM),
                    "Placebo" = "Плацебо",
                    "Crataegus" = "Боярышник")
  )

# 2) n на визите и респондеры среди оценённых
sum_by_visit <- resp_long %>%
  group_by(VISIT, Группа) %>%
  summarise(
    n = sum(has, na.rm = TRUE),
    responders = sum(resp[has], na.rm = TRUE),
    pct = 100 * responders / n,
    resp_fmt = sprintf("%d (%.1f%%)", responders, pct),
    n_fmt = as.character(n),
    .groups = "drop"
  )

# 3) p-value (χ² с поправкой Йейтса) отдельно для 12 и 24 мес
pvals <- resp_long %>%
  filter(has) %>%                 # только пациенты с оценкой на визите
  group_by(VISIT) %>%
  summarise(
    p_value = {
      tab <- table(ARM, resp)     # 2×2
      suppressWarnings(chisq.test(tab, correct = TRUE)$p.value)  # Йейтс
    },
    .groups = "drop"
  ) %>%
  mutate(p_value = ifelse(p_value < 0.001, "<0.001", sprintf("%.3f", p_value)))

# 4) формируем таблицу "как в журнале": строки = показатели, колонки = группы
tab_n <- sum_by_visit %>%
  select(VISIT, Группа, value = n_fmt) %>%
  mutate(Показатель = "Число пациентов с оценкой KCCQ") %>%
  pivot_wider(names_from = Группа, values_from = value)

tab_resp <- sum_by_visit %>%
  select(VISIT, Группа, value = resp_fmt) %>%
  mutate(Показатель = "Клинически значимое улучшение (ΔKCCQ ≥ 5), n (%)") %>%
  pivot_wider(names_from = Группа, values_from = value)

final_tbl <- bind_rows(tab_n, tab_resp) %>%
  left_join(pvals, by = "VISIT") %>%
  mutate(`p-значение` = ifelse(Показатель == "Клинически значимое улучшение (ΔKCCQ ≥ 5), n (%)", p_value, "")) %>%
  select(
    VISIT,
    Показатель,
    Плацебо,
    Боярышник,
    `p-значение`
  ) %>%
  mutate(VISIT = factor(VISIT, levels = c("12 месяцев", "24 месяца")))

# 5) gt-оформление
tbl_resp <- final_tbl %>%
  gt(groupname_col = "VISIT") %>%
  tab_header(
    title = "Клинически значимое улучшение качества жизни по KCCQ",
    subtitle = "Улучшение определено как ΔKCCQ ≥ 5 баллов от исходного уровня. В анализ включены пациенты с оценкой на соответствующем визите."
  ) %>%
  cols_label(
    Показатель = "",
    Плацебо = "Плацебо",
    Боярышник = "Боярышник",
    `p-значение` = "p-значение"
  ) %>%
  cols_align("left", columns = c(Показатель)) %>%
  cols_align("center", columns = c(Плацебо, Боярышник, `p-значение`)) %>%
  fmt_missing(everything(), missing_text = "") %>%
  tab_options(
    table.font.size = px(12),
    row_group.font.weight = "bold",
    data_row.padding = px(4)
  )

tbl_resp

```



```{r}
# 1) Подготовка данных NT-proBNP
dat_bnp <- team1 %>%
  transmute(
    USUBJID,
    arm = factor(ARM, levels = c("Placebo", "Crataegus")),
    BNP0  = V1_BIO_NTPROBNP,
    BNP12 = ifelse(death_before_12m, NA, V6_BIO_NTPROBNP),
    BNP24 = ifelse(death_before_24m, NA, V8_BIO_NTPROBNP)
  ) %>%
  mutate(
    lBNP0  = log(BNP0),
    lBNP12 = log(BNP12),
    lBNP24 = log(BNP24)
  )
```


```{r}


ggplot(dat_bnp, aes(x = BNP0)) +
  geom_histogram(bins = 50, fill = "steelblue", color = "white") +
  scale_x_continuous(labels = scales::comma) +
  labs(
    x = "NT-proBNP, pg/mL",
    y = "Частота",
    title = "Распределение NT-proBNP"
  ) +
  theme_minimal()
```


```{r}
ggplot(dat_bnp, aes(x = lBNP0)) +
  geom_density(fill = "steelblue", alpha = 0.4) +
  labs(
    x = "log(NT-proBNP)",
    y = "Плотность",
    title = "Плотность распределения log(NT-proBNP)"
  ) +
  theme_minimal()
```
В связи с выраженной асимметрией распределения NT-proBNP анализ проводился с использованием логарифмического преобразования; результаты представлены в виде геометрических средних и отношений геометрических средних с 95% доверительными интервалами

```{r}
# log-ANCOVA для NT-proBNP

fit12 <- lm(lBNP12 ~ arm + lBNP0, data = dat_bnp)

res12 <- broom::tidy(fit12, conf.int = TRUE) %>%
  filter(term == "armCrataegus") %>%
  transmute(
    VISIT = "12 мес",
    ratio = exp(estimate),
    lcl   = exp(conf.low),
    ucl   = exp(conf.high),
    pval  = p.value
  )

fit24 <- lm(lBNP24 ~ arm + lBNP0, data = dat_bnp)

res24 <- broom::tidy(fit24, conf.int = TRUE) %>%
  filter(term == "armCrataegus") %>%
  transmute(
    VISIT = "24 мес",
    ratio = exp(estimate),
    lcl   = exp(conf.low),
    ucl   = exp(conf.high),
    pval  = p.value
  )

res12
res24
```

Исходные уровни NT-proBNP были сопоставимы между группами лечения. Анализ вторичной конечной точки был выполнен с использованием анализа ковариации (ANCOVA) после логарифмического преобразования значений NT-proBNP с поправкой на исходный уровень показателя. Результаты представлены в виде отношения геометрических средних между группами лечения с соответствующими 95% доверительными интервалами. 
Статистически значимых различий между группами лечения выявлено не было. Через 12 месяцев наблюдения отношение геометрических средних NT-proBNP (боярышник/плацебо) составило 0,99 (95% ДИ 0,94–1,05; p = 0,824). Через 24 месяца наблюдения соответствующее отношение геометрических средних составило 1,00 (95% ДИ 0,94–1,08; p = 0,914).
```{r}
#  helpers 
msd  <- function(m, s, d = 1) sprintf(paste0("%.", d, "f±%.", d, "f"), m, s)
ci95_ratio <- function(est, lcl, ucl, d = 2) sprintf(paste0("%.", d, "f (%.", d, "f до %.", d, "f)"), est, lcl, ucl)
fmt_p <- function(p) ifelse(is.na(p), "", ifelse(p < 0.001, "<0.001", sprintf("%.3f", p)))

# Геометрическое среднее = exp(mean(log(x)))
gmean <- function(x) exp(mean(log(x), na.rm = TRUE))
# Геометрическое SD (мультипликативное) = exp(sd(log(x)))
gsd   <- function(x) exp(sd(log(x), na.rm = TRUE))
gmsd  <- function(x, d = 2) sprintf(paste0("%.", d, "f×/÷%.", d, "f"), gmean(x), gsd(x)) # для справки

#  data (log-ready) 
dat_bnp <- team1 %>%
  transmute(
    USUBJID,
    arm = factor(ARM, levels = c("Placebo", "Crataegus")),
    BNP0  = V1_BIO_NTPROBNP,
    BNP12 = ifelse(death_before_12m, NA, V6_BIO_NTPROBNP),
    BNP24 = ifelse(death_before_24m, NA, V8_BIO_NTPROBNP)
  ) %>%
  mutate(
    BNP0  = ifelse(BNP0  <= 0, NA, BNP0),
    BNP12 = ifelse(BNP12 <= 0, NA, BNP12),
    BNP24 = ifelse(BNP24 <= 0, NA, BNP24),
    lBNP0  = log(BNP0),
    lBNP12 = log(BNP12),
    lBNP24 = log(BNP24)
  )

# log-ANCOVA effects: ratio (Crataegus/Placebo) 
log_ancova_eff <- function(ylog, section_label) {
  fit <- lm(reformulate(c("arm", "lBNP0"), response = ylog), data = dat_bnp)
  tidy(fit, conf.int = TRUE) %>%
    filter(term == "armCrataegus") %>%
    transmute(
      section = section_label,
      ratio = exp(estimate),
      lcl   = exp(conf.low),
      ucl   = exp(conf.high),
      ratio_ci = ci95_ratio(exp(estimate), exp(conf.low), exp(conf.high), 2),
      p = p.value
    )
}

e12 <- log_ancova_eff("lBNP12", "Через 12 месяцев")
e24 <- log_ancova_eff("lBNP24", "Через 24 месяца")

# section rows (геометрические средние; изменение как % от baseline) 
make_rows_log <- function(section, bnp_var, eff) {

  p <- dat_bnp %>% filter(arm == "Placebo")
  c <- dat_bnp %>% filter(arm == "Crataegus")

  yp <- p[[bnp_var]]; yc <- c[[bnp_var]]
  ip <- !is.na(yp);    ic <- !is.na(yc)

  blp <- p$BNP0[ip];   blc <- c$BNP0[ic]
  yp  <- yp[ip];       yc  <- yc[ic]

  # геометрические средние
  g_bl_p <- gmean(blp); g_bl_c <- gmean(blc)
  g_v_p  <- gmean(yp);  g_v_c  <- gmean(yc)

  # изменение как % (геометрическая "кратность"): (GM_visit/GM_base - 1)*100
  chg_p <- (g_v_p / g_bl_p - 1) * 100
  chg_c <- (g_v_c / g_bl_c - 1) * 100

  tibble(
    Секция = section,
    `Конечная точка` = c(
      "Число пациентов с оценкой NT-proBNP",
      "Исходное значение — геом. среднее, pg/mL",
      "Значение на визите — геом. среднее, pg/mL",
      "Изменение от исходного — %, геом. среднее*"
    ),
    `Плацебо` = c(
      sum(ip),
      sprintf("%.0f", g_bl_p),
      sprintf("%.0f", g_v_p),
      sprintf("%+.1f", chg_p)
    ),
    `Боярышник` = c(
      sum(ic),
      sprintf("%.0f", g_bl_c),
      sprintf("%.0f", g_v_c),
      sprintf("%+.1f", chg_c)
    ),
    `Отношение геом. средних (ANCOVA), 95% ДИ` = c("", "", "", eff$ratio_ci),
    `p-значение` = c("", "", "", fmt_p(eff$p))
  )
}

#  baseline block (all with baseline) 
base_p <- dat_bnp$BNP0[dat_bnp$arm == "Placebo" & !is.na(dat_bnp$BNP0)]
base_c <- dat_bnp$BNP0[dat_bnp$arm == "Crataegus" & !is.na(dat_bnp$BNP0)]

base_rows <- tibble(
  Секция = "Исходно",
  `Конечная точка` = c("Число пациентов с оценкой NT-proBNP", "Значение — геом. среднее, pg/mL"),
  `Плацебо` = c(length(base_p), sprintf("%.0f", gmean(base_p))),
  `Боярышник` = c(length(base_c), sprintf("%.0f", gmean(base_c))),
  `Отношение геом. средних (ANCOVA), 95% ДИ` = c("", ""),
  `p-значение` = c("", "")
)

#  final table 
tbl_df <- bind_rows(
  base_rows,
  make_rows_log("Через 12 месяцев", "BNP12", e12),
  make_rows_log("Через 24 месяца", "BNP24", e24)
)

tbl_bnp_log <- tbl_df %>%
  gt(groupname_col = "Секция") %>%
  tab_header(
    title = "NT-proBNP: динамика (log-ANCOVA)",
    subtitle = "NT-proBNP проанализирован после лог-преобразования; представлены геометрические средние. Межгрупповый эффект — отношение геом. средних (Crataegus/Placebo), 95% ДИ."
  ) %>%
  cols_align("left", `Конечная точка`) %>%
  cols_align("center", -c(Секция, `Конечная точка`)) %>%
  fmt_missing(everything(), missing_text = "") %>%
  tab_options(
    table.font.size = px(12),
    row_group.font.weight = "bold",
    data_row.padding = px(4)
  ) %>%
  tab_source_note(
    source_note = "*Изменение от исходного рассчитано как (геом. среднее на визите / геом. среднее исходно − 1)×100%."
  )

tbl_bnp_log
```
Таблица Х. Динамика уровня NT-proBNP



Дополнительно динамика уровни NT-proBNP в зависимости от группы лечения в различных сроках наблюдения отражены на рисунке Х. 

```{r}
# 1) Сводка для графика: геометрическое среднее и 95% ДИ
bnp_sum <- dat_bnp %>%
  pivot_longer(cols = c(lBNP0, lBNP12, lBNP24),
               names_to = "VISIT", values_to = "lBNP") %>%
  mutate(
    VISIT = factor(VISIT,
      levels = c("lBNP0", "lBNP12", "lBNP24"),
      labels = c("Исходно", "12 месяцев", "24 месяца")
    )
  ) %>%
  group_by(arm, VISIT) %>%
  summarise(
    n = sum(!is.na(lBNP)),
    m = mean(lBNP, na.rm = TRUE),
    se = sd(lBNP, na.rm = TRUE) / sqrt(n),
    mean = exp(m),
    lcl  = exp(m - qt(0.975, df = n - 1) * se),
    ucl  = exp(m + qt(0.975, df = n - 1) * se),
    .groups = "drop"
  )

# 2) График
pd <- position_dodge(width = 0.25)

ggplot(bnp_sum, aes(x = VISIT, y = mean, group = arm, colour = arm)) +
  geom_line(position = pd, linewidth = 0.9) +
  geom_point(position = pd, size = 2.2) +
  geom_errorbar(aes(ymin = lcl, ymax = ucl),
                position = pd, width = 0.12, linewidth = 0.7) +
  scale_y_continuous(
    limits = c(200, 2000),
    breaks = seq(200, 2000, 200)
  ) +
  labs(
    y = "NT-proBNP, геометрическое среднее (95% ДИ), pg/mL",
    x = NULL,
    colour = "Группа лечения"
  ) +
  theme_minimal(base_size = 12)
```
Рисунок X. Динамика уровня NT-proBNP 


