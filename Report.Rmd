---
title: '**Проспективное, многоцентровое, рандомизированное, двойное слепое, плацебо-контролируемое клиническое исследование эффективности и безопасности экстракта боярышника (Crataegus) у пациентов с хронической сердечной недостаточностью со сниженной фракцией выброса левого желудочка.**'
author: 'Выполнил(и): Бектур	Бердибеков, Анастасия	Генералова, Ирина	Михайлова, Фирюза Лаптева'
output:
  word_document:
    toc: true
    toc_depth: 4
  html_document:
    number_sections: true
    code_folding: hide
    toc: true
    toc_float: true
    toc_depth: 4
  pdf_document:
    toc: true
    toc_depth: 4
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(flextable)
library(tidyverse)
library(summarytools)
library(survminer)      # для выживаемости
library(survival) 
library(survRM2)        # для RMST
library(gt)             # форматирование таблиц
library(kableExtra)
```

```{r}
team1 <- read.csv("data/team1_ecrf_wide.csv", sep = ",")
data_surv <- team1 |> 
  select(
    id     = USUBJID,
    group  = ARM,
    Time   = V0_END_TTE_COMP_M,
    Event_OS = V0_END_COMP_EVENT,
    type   = V0_END_COMP_TYPE
  )
```

# ПКТ

Для оценка первичной конечной точки  будет проведен анализ с использованием модели пропорциональных рисков Кокса (Cox Proportional Hazards Model).

Для подтверждения корректности использования модели Кокса была проведена проверка допущения о пропорциональности рисков (тест на основе остатков Шонфилда). Результаты теста (p=0.28 для группы терапии и p=0.28 для модели в целом) подтверждают соблюдение допущения о пропорциональности рисков. Это позволяет считать полученную оценку Hazard Ratio (HR) корректной и стабильной на всем интервале наблюдения (24 месяца).

Данное конфирматорное исследование было спланировано с мощностью 80% для обнаружения HR=0.78. Полученный результат HR=1.01 при p=0.87 свидетельствует о том, что в данной популяции пациентов, получающих оптимальную современную терапию ХСН, добавление экстракта боярышника не приносит дополнительного статистически значимого снижения риска по жестким конечным точкам.

```{r}
cox_fit <- coxph(Surv(Time, Event_OS) ~ group, data = data_surv)

pretty_table <- cox_fit |>
  broom::tidy(exponentiate = TRUE, conf.int = TRUE) |>
  mutate(
    HR = sprintf("%.2f", estimate),
    `95% CI` = sprintf("%.2f-%.2f", conf.low, conf.high),
    p_value = case_when(
      p.value < 0.001 ~ "<0.001",
      p.value < 0.01 ~ sprintf("%.3f", p.value),
      TRUE ~ sprintf("%.3f", p.value)
    ),
    Significance = case_when(
      p.value < 0.001 ~ "***",
      p.value < 0.01 ~ "**",
      p.value < 0.05 ~ "*",
      TRUE ~ ""
    )
  ) |>
  select(
    Переменная = term,
    HR,
    `95% CI`,
    `p-value` = p_value,
    Significance
  ) |>
  kable()
# summary(cox_fit)
pretty_table
```

```{r fig.width=8, fig.height=6}
# Запускаем тест на пропорциональность
test_ph <- cox.zph(cox_fit)

print(test_ph)

# Рисуем графики для визуальной оценки

ggcoxzph(test_ph)
```
# ВКТ

Кривые выживаемости групп боярышника и плацебо практически полностью накладываются друг на друга на протяжении всех 24 месяцев. Наличие широких и пересекающихся доверительных интервалов (shaded areas) подтверждает отсутствие статистически значимого расхождения. Терапия не продемонстрировала превосходства над плацебо.

```{r fig.height=8, fig.width=10}
surv_object <- Surv(time = data_surv$Time, event = data_surv$Event_OS)

fit_2 <- survfit(surv_object ~ group, data = data_surv)

p2 <- ggsurvplot(fit_2, 
                 data = data_surv,
                 conf.int = TRUE,
                 surv.median.line = "hv",
                 xlab="Month",
                 risk.table = TRUE,
                 tables.height = 0.25,
                 pval = TRUE,
                 pval.coord = c(22, 0.7),
                 break.time.by = 6,
                 xlim = c(0, 24))
p2
```
Значение p=1(крайне редкое для реальных данных) указывает на абсолютную идентичность кривых накопления событий госпитализации в обеих группах. Это означает, что вероятность попасть в больницу с декомпенсацией СН была абсолютно одинаковой как для пациентов, принимавших Crataegus, так и для группы контроля. 

В отношении наиболее «жесткой» точки — смертности — наблюдается минимальное, статистически незначимое расхождение кривых. 
```{r  fig.height=8, fig.width=10}
event_types <- c("HF_HOSP", "CV_DEATH")

# Мапим по списку событий
plots_list <- map(event_types, function(current_event) {
  
  # Мы создаем колонку 'is_event', которая будет TRUE (1) для текущего типа события.
  temp_data <- data_surv %>%
    mutate(is_event = (type == current_event))
  fit <- survfit(Surv(Time, is_event) ~ group, data = temp_data)
  
  ggsurvplot(fit, 
             data = temp_data,
             conf.int = TRUE,
             risk.table = TRUE,
             pval = TRUE,
             legend.labs = c("Crataegus", "Placebo"), 
             legend.title = "Group",
             title = paste("Outcome:", current_event), # Используем current_event
             xlab = "Months",
             xlim = c(0, 24),
             break.time.by = 6,
             palette = "Dark2")
})

plots_list[[1]] # График для HF_HOSP
plots_list[[2]] # График для CV_DEATH
```






















